<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <!-- Redirect HTTP to HTTPS -->
        <rule name="HTTP to HTTPS redirect" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
        </rule>
        
        <!-- Redirect www to non-www -->
        <rule name="Redirect www to non-www" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTP_HOST}" pattern="^www\.(.*)$" />
          </conditions>
          <action type="Redirect" url="https://{C:1}/{R:1}" redirectType="Permanent" />
        </rule>
        
        <!-- SPA routing rule -->
        <rule name="SPA Routes" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <add input="{REQUEST_URI}" pattern="^/(api)" negate="true" />
          </conditions>
          <action type="Rewrite" url="/" />
        </rule>

        <!-- Serve offline.html when offline (for local development) -->
        <rule name="Offline Fallback" stopProcessing="true">
          <match url=".*" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <add input="{REMOTE_ADDR}" pattern="127.0.0.1|::1" />
          </conditions>
          <action type="Rewrite" url="/offline.html" />
        </rule>
      </rules>
      <outboundRules>
        <!-- Add Link headers for preloading critical resources -->
        <rule name="Add Preload Headers" preCondition="IsHTML">
          <match serverVariable="RESPONSE_Link" pattern=".*" />
          <action type="Rewrite" value="{R:0}, &lt;/images/Novora-Logo.png&gt;; rel=preload; as=image, &lt;/offline.html&gt;; rel=prefetch" />
        </rule>
        <preConditions>
          <preCondition name="IsHTML">
            <add input="{RESPONSE_CONTENT_TYPE}" pattern="^text/html" />
          </preCondition>
        </preConditions>
      </outboundRules>
    </rewrite>
    
    <!-- MIME types -->
    <staticContent>
      <clientCache>
        <!-- Default cache policy -->
        <cacheControlMode value="UseMaxAge" />
        <cacheControlMaxAge value="1.00:00:00" />
      </clientCache>
      
      <remove fileExtension=".json" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
      <remove fileExtension=".woff" />
      <mimeMap fileExtension=".woff" mimeType="application/font-woff" />
      <remove fileExtension=".woff2" />
      <mimeMap fileExtension=".woff2" mimeType="application/font-woff2" />
      <remove fileExtension=".webmanifest" />
      <mimeMap fileExtension=".webmanifest" mimeType="application/manifest+json" />
      <remove fileExtension=".svg" />
      <mimeMap fileExtension=".svg" mimeType="image/svg+xml" />
      <remove fileExtension=".webp" />
      <mimeMap fileExtension=".webp" mimeType="image/webp" />
      <remove fileExtension=".mp4" />
      <mimeMap fileExtension=".mp4" mimeType="video/mp4" />
      <remove fileExtension=".webm" />
      <mimeMap fileExtension=".webm" mimeType="video/webm" />
      <remove fileExtension=".ogg" />
      <mimeMap fileExtension=".ogg" mimeType="audio/ogg" />
    </staticContent>
    
    <!-- HTTP response headers -->
    <httpProtocol>
      <customHeaders>
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-XSS-Protection" value="1; mode=block" />
        <add name="X-Frame-Options" value="SAMEORIGIN" />
        <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
        <add name="Permissions-Policy" value="camera=(), microphone=(), geolocation=()" />
        <add name="Content-Security-Policy" value="default-src 'self' https://images.unsplash.com https://fonts.googleapis.com https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://www.google-analytics.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https://images.unsplash.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://www.google-analytics.com;" />
      </customHeaders>
    </httpProtocol>
    
    <!-- Enable HTTP compression -->
    <urlCompression doStaticCompression="true" doDynamicCompression="true" />
    
    <!-- Configure caching for different file types -->
    <caching>
      <profiles>
        <!-- HTML - No caching -->
        <add extension=".html" policy="DisableCache" kernelCachePolicy="DisableCache" />
        <add extension=".htm" policy="DisableCache" kernelCachePolicy="DisableCache" />
        
        <!-- CSS and JavaScript - Long cache -->
        <add extension=".css" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".js" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        
        <!-- Images - Long cache -->
        <add extension=".jpg" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".jpeg" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".png" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".gif" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".svg" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".webp" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".ico" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        
        <!-- Fonts - Long cache -->
        <add extension=".woff" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".woff2" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".ttf" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".otf" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".eot" policy="CacheForTimePeriod" duration="31536000" varyByHeaders="Accept-Encoding" location="Any" />
        
        <!-- Service worker - No caching -->
        <add extension=".sw.js" policy="DisableCache" kernelCachePolicy="DisableCache" />
        
        <!-- Manifest - Short cache -->
        <add extension=".json" policy="CacheForTimePeriod" duration="86400" varyByHeaders="Accept-Encoding" location="Any" />
        <add extension=".webmanifest" policy="CacheForTimePeriod" duration="86400" varyByHeaders="Accept-Encoding" location="Any" />
      </profiles>
    </caching>

    <!-- Configure HTTP compression -->
    <httpCompression>
      <dynamicTypes>
        <add mimeType="text/*" enabled="true" />
        <add mimeType="message/*" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="application/xml" enabled="true" />
        <add mimeType="*/*" enabled="false" />
      </dynamicTypes>
      <staticTypes>
        <add mimeType="text/*" enabled="true" />
        <add mimeType="message/*" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
        <add mimeType="application/json" enabled="true" />
        <add mimeType="application/xml" enabled="true" />
        <add mimeType="application/font-woff" enabled="true" />
        <add mimeType="application/font-woff2" enabled="true" />
        <add mimeType="image/svg+xml" enabled="true" />
        <add mimeType="*/*" enabled="false" />
      </staticTypes>
    </httpCompression>

    <!-- Performance optimizations -->
    <serverRuntime enabled="true" frequentHitThreshold="1" frequentHitTimePeriod="00:00:20" />
  </system.webServer>

  <!-- Configure ASP.NET settings (if applicable) -->
  <system.web>
    <compilation debug="false" />
    <httpRuntime enableVersionHeader="false" />
  </system.web>
</configuration>